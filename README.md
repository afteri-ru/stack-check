# Proof of concept for automatic stack overflow checking when calling functions.


Проверка концепции защиты стека от переполнения для С++ на уровне исходного текста программы.

Проект реализуется в рамках концепции [доверенного программирования на С++](https://github.com/afteri-ru/trusted-cpp) и релаизации гарантий безопасного прогррамирования на уровне исходного текста программы.

Реализация выполнена в виде свпосмогательного файла stack_info и плагина для CLang, который оброаботывает исхлодный текст програиммы и добавляет в геренрируемый код необходиымне проверки для защиты стека от переполнения.

Реализацтия на уровне исходного текста программ заключается в добавлении нового С++ атрубита [[stack_overflow_check]], который обрабарабатыевается плагином компилятора и может быть использован при определении функции (метода класса) или перед вызвовм функции (метода класса) следующим образом:

- [[stack_overflow_check( N )]], где N больше нуля - вставить ручные проверку свободного места на стеке и в случае, если свободного места на стеке будет меньше **N**, то будет сгенерировано исключение `stack_overflow`. Если атрибут использован при опеределении функции, тогда проверка переполнения стека будет вставляться перед каждым вызовом функици автоматичсеки. Атрбут может быть указан непосредствено перед вызовм любой функции, тогда код проверки свободного места на стеке будет вставлен в этом месте однократно.

`[[stack_overflow_check(-1)]]` - Отменить вставку кода для проверки свободного места на стеке. Атрбут может быть указан непосредствено перед вызовм любой функции, тогда код проверки свободного места на стеке не будет вставлен в этом месте, даже если функция ранее была определна с атрубутом `stack_overflow_check`.

`[[stack_overflow_check]]` или `[[stack_overflow_check(0)]]` при опеределении функции - включить автоматичческую проверку свободного места на стеке перед какждым вызовом данной функции, а размер стека для проверки будет вычисляться автоматически.

Вычисление необходимого размера стека для вызова функции зависит от множества факторов, таких как целевая платформа, степени оптимизации, соглашения о вызове конкретной функции и т.д. из-за чего его нельзя вычислить с помощью статического анализатора кода на основе AST, а можно определить только после генерации машинных инструкций.

Причем, если размер стека у функция с защитой от переполнения стека должен вычисляться **автоматически**, то все вызываемые из нее функции так же должны быть защищены от переполнения стека. Это может быть реализовано либо за счет функций с автоматической защищитой стека от переполнения, либо установкой аттрибута непосредствено перед вызовм остальных функции с указаним проверяемого размера свободного места на стеке в **ручном режиме**, т.е. `[[stack_overflow_check( N )]]`, где `N` - цело число больше нуля.

```cpp
    [[stack_overflow_check]]
    int stack_guard_func(){
        int temp[10] = {0};
        
        [[stack_overflow_check(100)]]
        stack_unguard_func();

        return 0
    }
```

## Ошибки переполнения стека

Необходимый размер свободного места на стеке для вызова функции состоит из двух компонетов:
- размер свободного места на стеке, достаточного для непосредственного вызова текущей функции.
- фиксированого резервного размера, достаточного для создания исключения с информацией об ошибке и выполнения всех необходых для этого вызвов функци, которым так же может потребоваться стек в текущем потоке.

Фиксированный резервный размер для обработки ошибки зависит от релиазции и на него влияет целевая платформа, операционная система, степень оптизации программы и прочие факторы. В настоящий момент для обработки ошибки используется резервный размер 4500 байт и при проверке свободного места на стеке он автоматически добавляется к проверяемому размеру стека при вызове функции.

## Детали реализации и накладные расходы

Основоная фукнциональность для контроля стека от переполнения находится в файде `stack_info.h` и `stack_info.cpp` в структуре `trust::stack_info`. Информация о размере стека хранится в статических полях стурктуры, индивидуальных для кахдого потока (Thread Local -локальное хранилище потоков, TLS), что позвоялет однократно запрашивать параметры стека для каждого потока при инициализации структуры, а при проверке размера свободного места на стеке с помощью метода `stack_info::check_overflow(N)` - толкьо сравнивать текущий указатель стека с нижней границей выделенной под стек области памяти.

Проверка стка на переполнение, даже в случае максмальной оптимизации, не может быть короче двух машинных инструкций (операции сравнения и оператора короткого перехода), что увеличивает время вызова функции (оператор вызов подпрограммы). Оценка влияния контроля стека от переполнения на скорость работы приложения без оптимизации (`-O0`) - увеличивает время выполнения примерно на 10%, а при максимальной оптимизации (`-O3`) время выполнения увеличивается примерно на 15% (время выполнение приложения около 100мс).
